# Lesson 3: 多代理协作工作流

## 🎯 学习目标

- 理解多代理协作的概念和优势
- 掌握代理链式工作流的构建
- 实际应用：营销数据分析与优化流水线
- 学会设计复杂的多步骤工作流

## 📖 理论基础

### 什么是多代理协作？

多代理协作是指多个专门 AI 代理协同工作，每个代理专注于特定领域，通过信息传递和任务分工完成复杂任务。

### 协作模式

1. **链式工作流** - A → B → C 的顺序执行
2. **并行处理** - 多个代理同时处理不同方面
3. **主从模式** - 主代理协调多个子代理
4. **反馈循环** - 代理间相互验证和改进

### 协作的优势

- **专业分工** - 每个代理专注擅长领域
- **上下文传递** - 信息无损流转，避免重复分析
- **质量一致** - 基于统一分析标准
- **可扩展性** - 轻松添加更多专门代理

## 🚀 实战演练

### 步骤 1: 创建专门代理

```bash
# 创建数据分析师
/agents create marketing-data-analyzer "专门分析营销数据，识别表现异常的广告，计算关键指标如CTR、转化率、ROI等"

# 创建广告优化师
/agents create ad-optimizer "基于数据分析结果，为表现差的广告生成优化建议和新的变体方案"

# 创建 Linus 风格审查员
/agents create linus-code-reviewer "以 Linus Torvalds 的视角审查代码质量，关注数据结构优先，消除特殊情况"
```

### 步骤 2: 准备测试数据

创建 `sales-data.csv`:
```csv
ad_id,campaign,impressions,clicks,conversions,cost,revenue
001,春节营销,10000,500,25,2000,5000
002,春节营销,8000,200,8,1600,1600
003,夏季促销,15000,1200,80,3000,12000
004,夏季促销,5000,100,2,1000,400
005,黑五大促,20000,2000,150,4000,22500
006,黑五大促,12000,300,10,2400,2000
007,年终清仓,8000,400,20,1600,4000
008,年终清仓,3000,50,1,600,200
```

### 步骤 3: 链式执行

```bash
# 第一阶段：数据分析
marketing-data-analyzer 分析 @sales-data.csv

# 第二阶段：基于分析结果优化
ad-optimizer 基于前面的分析结果为表现差的广告生成优化方案
```

## 📊 实际案例：营销数据分析优化流水线

### 案例 1: 完整的营销分析流水线

#### 数据分析阶段
```
marketing-data-analyzer 分析 @sales-data.csv
```

**输出包含**：
- 关键指标计算 (CTR、转化率、ROI)
- 表现最差的 3 个广告识别
- 各 campaign 表现对比
- 数据洞察和问题诊断

#### 优化建议阶段
```
ad-optimizer 基于分析结果：
- 008号广告: ROI -66.7%, CTR 1.67% (最差)
- 004号广告: ROI -60%, CTR 2% (第二差)  
- 006号广告: ROI -16.7%, CTR 2.5% (第三差)
```

**输出包含**：
- 立即行动方案 (暂停亏损广告)
- 优化策略 (具体改进方向)
- 新广告变体 (基于成功模式)
- 预算调整建议 (资源重新分配)

### 案例 2: 代码质量审查流水线

#### 第一阶段: Linus 风格审查
```
linus-code-reviewer 分析 @bad-code.js
```

**输出包含**：
- 品味评分 (🟢/🟡/🔴)
- 致命问题识别
- Linus 式改进建议

#### 第二阶段: 安全扫描
```
security-expert 扫描 @bad-code.js 的安全问题
```

**输出包含**：
- 安全漏洞识别
- 风险等级评估
- 修复建议

#### 第三阶段: 重构规划
```
refactoring-specialist 基于前两个阶段的分析制定重构计划
```

**输出包含**：
- 分阶段重构清单
- 优先级排序
- 测试策略

## 🔄 高级协作模式

### 1. 并行处理模式

```bash
# 多个代理同时处理同一问题的不同方面
marketing-data-analyzer 分析 @data.csv 的用户行为模式
security-expert 分析 @data.csv 的隐私合规问题
performance-expert 分析 @data.csv 的系统性能影响
```

### 2. 主从协调模式

```bash
# 创建主协调代理
/agents create workflow-coordinator "协调多个专门代理的执行，收集和整合结果"

# 主代理分配任务给子代理
workflow-coordinator 协调以下任务：
1. 让 data-analyzer 分析数据趋势
2. 让 security-expert 检查安全问题  
3. 让 performance-expert 评估性能影响
4. 整合所有结果生成综合报告
```

### 3. 反馈循环模式

```bash
# 代理 A 分析 -> 代理 B 验证 -> 代理 A 改进
data-analyzer 分析 @data.csv
validation-expert 验证分析结果的准确性
data-analyzer 基于验证反馈改进分析方法
```

## 💡 设计原则

### 1. 单一职责原则
- 每个代理只专注一个专业领域
- 避免创建"万能代理"
- 细分任务，提高专业化程度

### 2. 上下文传递原则
- 明确定义代理间的输入输出格式
- 确保信息无损传递
- 避免重复分析相同内容

### 3. 错误处理原则
- 设计降级机制
- 处理代理失败的情况
- 提供备选方案

### 4. 性能优化原则
- 并行处理独立任务
- 避免不必要的代理调用
- 缓存重复使用的分析结果

## 🎯 实战案例模板

### 模板 1: 数据分析流水线

```markdown
# [项目名] 数据分析流水线

## 代理配置
- data-analyzer: 数据分析专家
- domain-expert: 领域专家
- optimizer: 优化建议专家

## 执行流程
1. data-analyzer 分析 @data-file
2. domain-expert 验证分析结果
3. optimizer 基于验证结果生成优化方案

## 输出格式
- 数据洞察报告
- 验证结果
- 优化建议清单
```

### 模板 2: 代码审查流水线

```markdown
# 代码质量审查流水线

## 代理配置
- code-reviewer: 代码质量审查
- security-expert: 安全检查
- performance-expert: 性能评估
- refactoring-expert: 重构规划

## 执行流程
1. code-reviewer 审查 @code-file
2. security-expert 安全扫描
3. performance-expert 性能分析
4. refactoring-expert 综合制定重构计划

## 输出格式
- 质量评分
- 安全问题清单
- 性能瓶颈分析
- 重构优先级
```

## 📝 练习作业

1. **基础练习**：创建一个简单的两代理协作流水线 (数据分析 → 报告生成)

2. **进阶练习**：设计一个三代理并行处理的工作流

3. **综合练习**：创建一个包含 5 个代理的复杂项目评估流水线

## 🎓 总结

- 多代理协作是 Claude Code 的核心高级功能
- 好的协作 = 清晰的分工 + 无损的传递 + 统一的标准
- 链式工作流可以实现复杂的业务流程自动化
- 设计时要考虑错误处理和性能优化

---

**下一课**: [高级技巧与最佳实践](../lesson-04-advanced/README.md)